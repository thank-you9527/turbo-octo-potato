name: Build Windows Portable

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Print Node and npm versions
        shell: pwsh
        run: |
          node -v
          npm -v

      - name: Force disable proxies for this job
        shell: pwsh
        run: |
          @(
            "HTTP_PROXY=",
            "HTTPS_PROXY=",
            "ALL_PROXY=",
            "http_proxy=",
            "https_proxy=",
            "all_proxy="
          ) | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          npm config delete proxy       --location=global 2>$null
          npm config delete http-proxy  --location=global 2>$null
          npm config delete https-proxy --location=global 2>$null

          npm config delete proxy       2>$null
          npm config delete http-proxy  2>$null
          npm config delete https-proxy 2>$null

          npm config set registry https://registry.npmjs.org/

          npm config set fund false
          npm config set audit false

          npm config get registry
          npm config get proxy
          npm config get https-proxy

          npm config list

      - name: Check npm registry connectivity (via npm)
        shell: pwsh
        run: |
          npm view @types/node version

      - name: Install dependencies
        shell: pwsh
        run: npm install

      - name: Build portable exe
        shell: pwsh
        run: npm run build

      - name: List dist outputs
        shell: pwsh
        run: |
          if (Test-Path dist) {
            Get-ChildItem -Recurse dist | Format-Table FullName, Length
            Get-ChildItem -Recurse dist -Filter *.exe | Format-Table FullName, Length
            if (!(Get-ChildItem -Recurse dist -Filter *.exe)) {
              Write-Host "No exe files found under dist/"
              exit 1
            }
          } else {
            Write-Host "dist/ does not exist"
            exit 1
          }

      - name: Ensure baseware_root is packaged next to exe
        shell: pwsh
        run: |
          if (!(Test-Path dist/baseware_root)) {
            Copy-Item -Recurse -Force baseware_root dist/baseware_root
          }

      - name: Package release zip
        shell: pwsh
        run: |
          Compress-Archive -Path dist/Baseware.exe,dist/baseware_root -DestinationPath dist/Baseware-win-portable.zip -Force

      - name: Upload portable zip
        uses: actions/upload-artifact@v4
        with:
          name: Baseware-win-portable
          path: dist/Baseware-win-portable.zip

      - name: Upload exe artifacts (glob)
        uses: actions/upload-artifact@v4
        with:
          name: Baseware-exe
          path: dist/**/*.exe
